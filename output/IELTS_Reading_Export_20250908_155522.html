<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>雅思阅读</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
    #top-timer-bar { position:fixed; top:0; left:0; width:100%; height:36px; background:rgba(255,255,255,0.97); z-index:9999; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,.07); }
    #top-timer { font-size:16px; font-weight:600; color:var(--accent); background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 24px; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .shell { margin-top:36px; display:flex; height:calc(100vh - 36px); width:100%; }
    .pane { background:var(--panel); overflow:auto; padding:20px; }
    #left { flex: 0 0 50%; min-width: 280px; }
    #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
    #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
    #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
    .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
    .hl:hover { filter: brightness(0.98); }
    #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: 0 6px 20px rgba(0,0,0,.12); font-size: 13px; gap:6px; align-items: center; }
    #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
    #selbar button:hover { border-color:#fff; }
    #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid #e5e7eb; border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: 0 6px 20px rgba(0,0,0,.12); }
    #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid #e5e7eb; }
    #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
    #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  </style>
</head>
<body>
  <div id="top-timer-bar"><span id="top-timer">00:00</span></div>
  <div class="shell">
    <section class="pane" id="left"><h2>阅读材料</h2><div></div></section>
    <div id="divider"></div>
    <section class="pane" id="right"><h2>题目</h2><ol><li><div><b>Q1:</b> Soccer is played in the street and in youth teams. Which is more organized?</div><div><label style='display:block;margin:4px 0'><input type='radio' name='q1'/> Street</label><label style='display:block;margin:4px 0'><input type='radio' name='q1'/> Youth team<span style='color:#3b82f6;margin-left:8px'>(正确答案)</span></label></div></li></ol></section>
  </div>
  <script>
    // 顶部计时器
    let _t=0; const _timerEl=document.getElementById('top-timer');
    setInterval(function(){ 
      _t++; 
      var m=String(Math.floor(_t/60)).padStart(2,'0'); 
      var s=String(_t%60).padStart(2,'0'); 
      _timerEl.textContent=m+':'+s; 
    },1000);
    // Hightlight/Note工具栏
    var selbar = document.createElement('div');
    selbar.id = 'selbar';
    selbar.innerHTML = `
      <button id='btnHL'>Hightlight</button>
      <button id='btnUH'>Remove</button>
      <button id='btnNote'>Note</button>
    `;
    document.body.appendChild(selbar);
    var lastRange = null;
    function getSelectionRect() {
      var sel = window.getSelection();
      if (!sel.rangeCount) return null;
      var range = sel.getRangeAt(0);
      var rect = range.getBoundingClientRect();
      return rect;
    }
    function updateSelbar() {
      var sel = window.getSelection();
      if (!sel.isCollapsed && sel.toString().length > 0) {
        var rect = getSelectionRect();
        if (rect) {
          selbar.style.display = 'flex';
          selbar.style.left = rect.left + window.scrollX + 'px';
          selbar.style.top = (rect.bottom + window.scrollY + 5) + 'px';
          lastRange = sel.getRangeAt(0).cloneRange();
        }
      } else {
        selbar.style.display = 'none';
      }
    }
    document.getElementById('left').addEventListener('mouseup', updateSelbar);
    document.getElementById('left').addEventListener('keyup', updateSelbar);
    selbar.addEventListener('mousedown', function(e){ e.preventDefault(); });
    function doHighlight() {
      if (lastRange) {
        var span = document.createElement('span');
        span.className = 'hl';
        lastRange.surroundContents(span);
        window.getSelection().removeAllRanges();
        selbar.style.display = 'none';
      }
    }
    function removeHighlight() {
      if (lastRange) {
        var sel = window.getSelection();
        var range = lastRange;
        var container = range.commonAncestorContainer;
          var parent = container.nodeType === 3 ? container.parentNode : container;
          if (parent.classList && parent.classList.contains('hl')) {
            var text = parent.textContent;
            var newNode = document.createTextNode(text);
            parent.parentNode.replaceChild(newNode, parent);
            selbar.style.display = 'none';
            sel.removeAllRanges();
          }
      }
        if (!lastRange) return;
        // 支持框选范围覆盖多个高亮区域时批量取消高亮
        var selRect = lastRange.getBoundingClientRect();
        var walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
        var toRemove = [];
        while (walker.nextNode()) {
          var n = walker.currentNode;
          if (n.classList && n.classList.contains('hl')) {
            var r = n.getBoundingClientRect();
            // 只要有交集就移除（即使框选比高亮大）
            if (!(r.right < selRect.left || r.left > selRect.right || r.bottom < selRect.top || r.top > selRect.bottom)) toRemove.push(n);
          }
        }
        if (toRemove.length === 0) {
          selbar.style.display = 'none';
          //showToast('No highlight found');
          return;
        }
        toRemove.forEach(function(el) {
          var p = el.parentNode;
          while (el.firstChild) p.insertBefore(el.firstChild, el);
          p.removeChild(el);
          p.normalize();
        });
        selbar.style.display = 'none';
        showToast('Highlight removed');
    }
    document.getElementById('btnHL').onclick = doHighlight;
    document.getElementById('btnUH').onclick = removeHighlight;
    // Note功能
    var notes = document.createElement('div');
    notes.id = 'notes';
    notes.innerHTML = `<header><span>Note</span><button id='btnClose'>关闭</button></header><textarea id='noteArea' placeholder='Your note...'></textarea>`;
    document.body.appendChild(notes);
    document.getElementById('btnNote').onclick = function() {
      // 获取选中内容
      let text = '';
      if (lastRange) {
        var frag = lastRange.cloneContents();
        text = (frag.textContent || '').trim();
      }
      if (text) {
        var noteArea = document.getElementById('noteArea');
        noteArea.value = (noteArea.value ? noteArea.value + '\n' : '') + '> ' + text + '\n';
      }
      notes.style.display = 'flex';
      selbar.style.display = 'none';
    };
    document.getElementById('btnClose').onclick = function() {
      notes.style.display = 'none';
    };
  </script>
</body>
</html>
