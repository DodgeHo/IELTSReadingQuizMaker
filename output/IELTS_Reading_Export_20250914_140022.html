<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>雅思阅读</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root { --line:#e5e7eb; --bg:#f6f7fb; --panel:#fff; --accent:#3b82f6; --muted:#6b7280; --shadow:0 6px 20px rgba(0,0,0,.12); }
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); }
    #top-timer-bar { position:fixed; top:0; left:0; width:100%; height:36px; background:rgba(255,255,255,0.97); z-index:9999; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,.07); }
    #top-timer { font-size:16px; font-weight:600; color:var(--accent); background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 24px; box-shadow:0 1px 4px rgba(0,0,0,.04); }
    .shell { margin-top:36px; display:flex; height:calc(100vh - 36px); width:100%; }
    .pane { background:var(--panel); overflow:auto; padding:20px; }
    #left { flex: 0 0 50%; min-width: 280px; }
    #right { flex: 1 1 auto; min-width: 320px; background:#fbfbff; border-left:1px solid var(--line); }
    #divider { flex: 0 0 8px; background: linear-gradient(90deg,#e5e7eb,#d1d5db); cursor: ew-resize; position:relative; z-index: 5; user-select:none; }
    #left p { margin: 0 0 12px; line-height: 1.6; word-break: normal; overflow-wrap: normal; hyphens: none; }
    /* 表格样式 */
    table { border-collapse: collapse; width: 100%; margin: 12px 0; }
    th, td { border: 1px solid var(--line); padding: 8px 12px; text-align: left; vertical-align: top; }
    th { background: #f8fafc; font-weight: bold; }
    td { background: #fff; }
    /* ReactQuill生成的样式支持 */
    .ql-align-center { text-align: center; }
    .ql-align-right { text-align: right; }
    .ql-align-left { text-align: left; }
    .ql-align-justify { text-align: justify; }
    .ql-indent-1 { margin-left: 2em; }
    .ql-indent-2 { margin-left: 4em; }
    .ql-indent-3 { margin-left: 6em; }
    .ql-indent-4 { margin-left: 8em; }
    .ql-indent-5 { margin-left: 10em; }
    .ql-indent-6 { margin-left: 12em; }
    .ql-indent-7 { margin-left: 14em; }
    .ql-indent-8 { margin-left: 16em; }
    h1.ql-align-center, h2.ql-align-center, h3.ql-align-center, h4.ql-align-center, h5.ql-align-center, h6.ql-align-center { text-align: center; }
    h1.ql-align-right, h2.ql-align-right, h3.ql-align-right, h4.ql-align-right, h5.ql-align-right, h6.ql-align-right { text-align: right; }
    h1.ql-align-justify, h2.ql-align-justify, h3.ql-align-justify, h4.ql-align-justify, h5.ql-align-justify, h6.ql-align-justify { text-align: justify; }
    p.ql-align-center, p.ql-align-right, p.ql-align-justify { margin: 0 0 12px; line-height: 1.6; }
    .hl { background:#fff3a3; box-shadow: inset 0 -2px 0 rgba(0,0,0,.05); cursor: pointer; }
    .hl:hover { filter: brightness(0.98); }
    #selbar { position: absolute; display:none; z-index: 2000; background:#111; color:#fff; border-radius: 8px; padding: 6px; box-shadow: 0 6px 20px rgba(0,0,0,.12); font-size: 13px; gap:6px; align-items: center; }
    #selbar button { background: transparent; color:#fff; border: 1px solid rgba(255,255,255,.25); padding: 4px 8px; border-radius: 6px; cursor:pointer; }
    #selbar button:hover { border-color:#fff; }
    #notes { position: fixed; right: 12px; bottom: 12px; width: 320px; height: 42vh; background:#fff; border:1px solid #e5e7eb; border-radius: 12px; display:none; flex-direction: column; z-index:1500; box-shadow: 0 6px 20px rgba(0,0,0,.12); }
    #notes header { display:flex; align-items:center; justify-content: space-between; padding:8px 10px; border-bottom:1px solid #e5e7eb; }
    #notes textarea { flex:1; border:0; padding:10px; resize:none; font-size:14px; line-height:1.5; }
    #toast { position: fixed; left:50%; transform: translateX(-50%); bottom: 24px; background:#111; color:#fff; padding:8px 12px; border-radius: 8px; display:none; z-index:2500; }
  </style>
</head>
<body>
  <div id="top-timer-bar"><span id="top-timer">00:00</span></div>
  <div class="shell">
    <section class="pane" id="left"><h2>阅读材料</h2><div></div></section>
    <div id="divider"></div>
    <section class="pane" id="right"><h4>Questions</h4><div style='border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:18px;background:#f9fafb'><div style='margin-bottom:15px'><p>Match each statement with the correct option. Drag the correct letter into each box. You may use any letter more than once if allowed.</p></div><div style='margin-bottom:18px;padding:12px;background:#fff;border-radius:6px'><div style='font-size:16px;line-height:1.6'><div class="matching-container" data-repeatable="false"><div style="margin-bottom:15px;"><div style="font-weight:bold;margin-bottom:8px;">选项：</div><div class="matching-options" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;"><div class="matching-option" draggable="true" data-oi="0" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">i The best moment to migrate</div><div class="matching-option" draggable="true" data-oi="1" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">ii The unexplained rejection of closer feeding grounds</div><div class="matching-option" draggable="true" data-oi="2" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">iii The influence of weather on the migration route</div><div class="matching-option" draggable="true" data-oi="3" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">iv Physical characteristics that allow birds to migrate</div><div class="matching-option" draggable="true" data-oi="4" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">v The main reason why birds migrate</div><div class="matching-option" draggable="true" data-oi="5" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">vi The best wintering grounds for birds</div><div class="matching-option" draggable="true" data-oi="6" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">vii Research findings on how birds migrate</div><div class="matching-option" draggable="true" data-oi="7" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">viii Successful migration despite the trouble of wind</div><div class="matching-option" draggable="true" data-oi="8" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">ix The contrast between long-distance migration and short-distance migration</div><div class="matching-option" draggable="true" data-oi="9" style="padding:6px 12px;background:#e0e7ff;border-radius:4px;cursor:grab;font-weight:bold;">x Mysterious migration despite lack of teaching</div></div></div><div><div style="font-weight:bold;margin-bottom:8px;">题目：</div><p>14 Paragraph A<span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="0" data-answer="2" data-question-num="1" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[1]</span></span></p><p>15 Paragraph B <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="1" data-answer="0" data-question-num="2" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[2]</span></span></p><p>16 Paragraph C <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="2" data-answer="1" data-question-num="3" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[3]</span></span></p><p>17 Paragraph D <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="3" data-answer="3" data-question-num="4" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[4]</span></span></p><p>18 Paragraph E <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="4" data-answer="8" data-question-num="5" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[5]</span></span></p><p>19 Paragraph F <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="5" data-answer="9" data-question-num="6" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[6]</span></span></p><p>20 Paragraph G <span style="background-color: rgb(224, 242, 254); color: rgb(239, 68, 68);"><span class="matching-drop" draggable="true" data-qi="6" data-answer="7" data-question-num="7" style="display:inline-block;min-width:120px;height:32px;background:#E2F2FE;border:1px dashed #0b80f5ff;border-radius:4px;margin:0 4px;text-align:center;line-height:32px;color:#000;font-weight:bold;cursor:pointer;vertical-align:middle;">[7]</span></span></p></div></div></div></div></div>
      <div id="answer-summary" style="margin-top:12px;padding:16px 12px;border-top:1px solid #e5e7eb;background:#f6f7fb;border-radius:8px;">
        <div id="completed-list" style="font-size:15px;color:#3b82f6;display:none;"></div>
        <div style="margin-top:18px;">
          <button id="btnSubmit" style="background:#3b82f6;color:#fff;border:none;border-radius:8px;padding:8px 20px;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer;margin-right:12px;">Submit</button>
          <button id="btnReset" style="background:#64748b;color:#fff;border:none;border-radius:8px;padding:8px 20px;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer;">Reset</button>
        </div>
        <div id="score-result" style="margin-top:18px;font-size:17px;font-weight:bold;color:#eab308;"></div>
      </div>
    </section>
  </div>
  <div class="practice-nav" id="practice-nav" style="background:#fff;border-top:2px solid #e5e7eb;padding:12px 20px;display:flex;align-items:center;gap:20px;box-shadow:0 2px 4px rgba(0,0,0,.05);flex-wrap:wrap;position:fixed;left:0;right:0;bottom:0;z-index:4000;">
    <span class="title" style="font-weight:600;color:#64748b;">Questions</span>
    <div class="questions" id="nav-questions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;"></div>
  </div>
  <script>
    // 题号导航条逻辑
    function updateNavQuestions() {
      const questions = getAllQuestions();
      const nav = document.getElementById('nav-questions');
      nav.innerHTML = '';
      questions.forEach((q, i) => {
        let hasAnswer = false;
        if(q.type === 'blank') {
          hasAnswer = q.input.value.trim() !== '';
        } else if(q.type === 'matching') {
          hasAnswer = q.drop.hasAttribute('data-student-answer');
        } else {
          hasAnswer = Array.from(q.radios).some(r => r.checked);
        }
        const btn = document.createElement('button');
        btn.textContent = q.questionNum || (i+1);
        btn.style.background = hasAnswer ? '#3b82f6' : '#e5e7eb';
        btn.style.color = hasAnswer ? '#fff' : '#64748b';
        btn.style.border = 'none';
        btn.style.borderRadius = '8px';
        btn.style.padding = '6px 12px';
        btn.style.fontWeight = 'bold';
        btn.style.fontSize = '15px';
        btn.style.cursor = 'pointer';
        btn.onclick = function() {
          q.el.scrollIntoView({behavior:'smooth',block:'center'});
        };
        nav.appendChild(btn);
      });
    }
    document.getElementById('right').addEventListener('change', function(e){
      if(e.target.type==='radio' || e.target.type==='checkbox' || e.target.className==='blank-input') {
        updateCompletedList();
        updateNavQuestions();
      }
    });
    // 监听填空题的输入事件
    document.getElementById('right').addEventListener('input', function(e){
      if(e.target.className==='blank-input') {
        updateNavQuestions();
      }
    });
    // 监听匹配题的拖拽事件
    document.addEventListener('dragstart', function(e) {
      if(e.target.classList.contains('matching-option')) {
        e.dataTransfer.setData('type', 'option');
        e.dataTransfer.setData('option-index', e.target.dataset.oi);
        e.dataTransfer.setData('text/plain', e.target.textContent);
      }
      if(e.target.classList.contains('matching-drop') && e.target.getAttribute('data-student-answer')) {
        e.dataTransfer.setData('type', 'drop');
        e.dataTransfer.setData('option-index', e.target.getAttribute('data-student-answer'));
        e.dataTransfer.setData('text/plain', e.target.textContent);
        window._dragSourceDrop = e.target;
      }
    });
    
    document.addEventListener('dragover', function(e) {
      if(e.target.classList.contains('matching-drop')) {
        e.preventDefault();
      }
    });
    
    document.addEventListener('drop', function(e) {
      if(e.target.classList.contains('matching-drop')) {
        e.preventDefault();
        const type = e.dataTransfer.getData('type');
        const text = e.dataTransfer.getData('text/plain');
        const optionIndex = e.dataTransfer.getData('option-index');
        const container = e.target.closest('.matching-container');
        const isRepeatable = container.dataset.repeatable === 'true';
        // 拖拽源是选项区
        if(type === 'option') {
          if(!isRepeatable) {
            // 检查该选项是否已被其他空选中
            const usedDrops = container.querySelectorAll('.matching-drop[data-student-answer="' + optionIndex + '"]');
            if(usedDrops.length > 0) {
              // 已被选，禁止再次拖拽
              return;
            }
          }
          if (text && text.trim()) {
            // 替换时，先恢复原选项区显示
            if(!isRepeatable) {
              const oldAnswer = e.target.getAttribute('data-student-answer');
              if(oldAnswer !== null && oldAnswer !== '' && oldAnswer !== optionIndex) {
                const oldOptions = container.querySelectorAll('.matching-option[data-oi="' + oldAnswer + '"]');
                oldOptions.forEach(opt => opt.style.display = 'inline-block');
              }
            }
            e.target.textContent = text;
            e.target.style.background = '#e0e7ff'; // 绿色背景表示已放置
            e.target.setAttribute('data-student-answer', optionIndex);
            // 不可复选时，隐藏选项区对应选项
            if(!isRepeatable) {
              const allOptions = container.querySelectorAll('.matching-option[data-oi="' + optionIndex + '"]');
              allOptions.forEach(opt => opt.style.display = 'none');
            }
          }
        }
        // 拖拽源是另一个空格，实现交换或移动
        if(type === 'drop') {
          const sourceText = text;
          const sourceIndex = optionIndex;
          // 目标空格原有选项
          const targetOldIndex = e.target.getAttribute('data-student-answer');
          const targetOldText = e.target.textContent;
          // 源空格
          const sourceDrop = document.querySelector('.matching-drop[data-student-answer="' + sourceIndex + '"]');
          if(sourceDrop) {
            // 目标空格为空，移动
            if(!targetOldIndex || targetOldIndex === '') {
              // 源空格变空
              sourceDrop.textContent = '[' + sourceDrop.getAttribute('data-question-num') + ']';
              sourceDrop.style.background = '#E2F2FE';
              sourceDrop.removeAttribute('data-student-answer');
              // 目标空格填入选项
              e.target.textContent = sourceText;
              e.target.style.background = '#e0e7ff';
              e.target.setAttribute('data-student-answer', sourceIndex);
            } else {
              // 交换
              // 源空格填入目标内容
              sourceDrop.textContent = targetOldText;
              sourceDrop.setAttribute('data-student-answer', targetOldIndex);
              sourceDrop.style.background = '#e0e7ff';
              // 目标空格填入源内容
              e.target.textContent = sourceText;
              e.target.setAttribute('data-student-answer', sourceIndex);
              e.target.style.background = '#e0e7ff';
            }
          }
        }
        // 不可复选时，更新选项区显示
        if(!isRepeatable) {
          // 先全部显示
          const allOptions = container.querySelectorAll('.matching-option');
          allOptions.forEach(opt => opt.style.display = 'inline-block');
          // 再隐藏已被选的
          const drops = container.querySelectorAll('.matching-drop[data-student-answer]');
          drops.forEach(drop => {
            const idx = drop.getAttribute('data-student-answer');
            if(idx !== null && idx !== '') {
              const opt = container.querySelector('.matching-option[data-oi="' + idx + '"]');
              if(opt) opt.style.display = 'none';
            }
          });
        }
        updateNavQuestions();
      }
    });
    
    document.addEventListener('click', function(e) {
      if(e.target.classList.contains('matching-clear')) {
        const dropZone = e.target.previousElementSibling;
        const container = dropZone.closest('.matching-container');
        const isRepeatable = container.dataset.repeatable === 'true';
        const oldAnswer = dropZone.dataset.answer;
        const questionNum = dropZone.dataset.questionNum;
        
        // 清空答案，显示题号
        dropZone.textContent = questionNum;
        dropZone.dataset.answer = '';
        dropZone.style.background = '#E2F2FE';
        dropZone.style.color = '#92400e';
        dropZone.style.border = '1px dashed #f59e0b';
        
        if(!isRepeatable && oldAnswer !== '') {
          // 选项不可重复：恢复显示被隐藏的选项
          const allOptions = container.querySelectorAll('.matching-option[data-oi="' + oldAnswer + '"]');
          allOptions.forEach(opt => opt.style.display = 'inline-block');
        }
        
        updateNavQuestions();
      }
    });
    updateNavQuestions();
    // 顶部计时器
    let _t=0; const _timerEl=document.getElementById('top-timer');
    setInterval(function(){ 
      _t++; 
      var m=String(Math.floor(_t/60)).padStart(2,'0'); 
      var s=String(_t%60).padStart(2,'0'); 
      _timerEl.textContent=m+':'+s; 
    },1000);

    // 答题统计与批改功能
    function getAllQuestions() {
      const qBlocks = document.querySelectorAll('#right ol > li');
      const blankInputs = document.querySelectorAll('#right input.blank-input');
      const matchingDrops = document.querySelectorAll('#right .matching-drop');
      let questions = [];
      
      // 处理选择题（在ol中）
      qBlocks.forEach((block, idx) => {
        const radios = block.querySelectorAll('input[type=radio],input[type=checkbox]');
        if(radios.length) {
          questions.push({
            el: block,
            radios,
            idx: questions.length,
            selected: null,
            correct: null,
            type: radios[0].type === 'checkbox' ? 'multi' : 'single'
          });
        }
      });
      
      // 处理填空题（每个空位单独作为一道题）
      blankInputs.forEach((input, idx) => {
        questions.push({
          el: input.closest('div'), // 找到包含的div
          input: input,
          idx: questions.length,
          type: 'blank',
          questionNum: input.dataset.questionNum || (questions.length + 1)
        });
      });

      // 处理匹配题（每个空位单独作为一道题）
      matchingDrops.forEach((drop, idx) => {
        questions.push({
          el: drop.closest('div'), // 找到包含的div
          drop: drop,
          idx: questions.length,
          type: 'matching',
          questionNum: drop.dataset.questionNum || (questions.length + 1)
        });
      });
      
      return questions;
    }
    function updateCompletedList() {
      // 默认隐藏，仅批改后显示
      document.getElementById('completed-list').style.display = 'none';
    }
    document.getElementById('right').addEventListener('change', function(e){
      if(e.target.type==='radio') updateCompletedList();
    });
    updateCompletedList();

    // 交卷批改功能
    document.getElementById('btnSubmit').onclick = function() {
      const questions = getAllQuestions();
      let correctCount = 0;
      let total = questions.length;
      let detailHtml = '';
      questions.forEach((q, i) => {
        if(q.type==='blank') {
          const correctAns = (q.input.dataset.answer || '').split(';').map(s=>s.trim().toLowerCase()).filter(s=>s);
          const userAns = (q.input.value || '').trim().toLowerCase();
          const qNum = q.questionNum || (i+1);
          if(userAns && correctAns.includes(userAns)) {
            correctCount++;
            q.input.style.background = '#e6ffed';
            detailHtml += `<div style='margin-bottom:4px'>Q${qNum}: <span style='color:#10b981'>${q.input.value}</span></div>`;
          } else {
            q.input.style.background = userAns ? '#ffe4e6' : '';
            detailHtml += `<div style='margin-bottom:4px'>Q${qNum}: <span style='color:#ef4444;font-weight:bold'>${q.input.value||'-'}</span> / <span style='color:#10b981'>${q.input.dataset.answer||'-'}</span></div>`;
          }
        } else if(q.type==='matching') {
          const correctAns = q.drop.dataset.answer || '';
          const userAns = q.drop.getAttribute('data-student-answer') || '';
          const qNum = q.questionNum || (i+1);
          if(userAns && userAns === correctAns) {
            correctCount++;
            q.drop.style.background = '#e6ffed';
            detailHtml += `<div style='margin-bottom:4px'>Q${qNum}: <span style='color:#10b981'>${q.drop.textContent}</span></div>`;
          } else {
            q.drop.style.background = userAns ? '#ffe4e6' : '';
            detailHtml += `<div style='margin-bottom:4px'>Q${qNum}: <span style='color:#ef4444;font-weight:bold'>${q.drop.textContent||'-'}</span> / <span style='color:#10b981'>正确答案</span></div>`;
          }
        } else {
          let answer = null;
          if(q.type==='multi') {
            // 多选题，正确答案可能有多个
            let correctArr = [];
            q.radios.forEach(r => {
              if(r.dataset.answer==='true') correctArr.push(r.value);
            });
            let userArr = Array.from(q.radios).filter(r=>r.checked).map(r=>r.value);
            let isCorrect = userArr.length===correctArr.length && userArr.every(v=>correctArr.includes(v));
            if(isCorrect && userArr.length) {
              correctCount++;
              q.el.style.background = '#e6ffed';
              detailHtml += `<div style='margin-bottom:6px;'>Q${i+1}: <span style='color:#10b981'>${userArr.join(', ')}</span></div>`;
            } else {
              q.el.style.background = userArr.length ? '#ffe4e6' : '';
              detailHtml += `<div style='margin-bottom:6px;'>Q${i+1}: <span style='color:#ef4444;font-weight:bold'>${userArr.join(', ')||'Not selected'}</span> / <span style='color:#10b981'>${correctArr.join(', ')||'-'}</span></div>`;
            }
          } else {
            q.radios.forEach(r => {
              if(r.dataset.answer==='true') answer = r.value;
            });
            let sel = Array.from(q.radios).find(r=>r.checked);
            let userAns = sel ? sel.value : 'Not selected';
            if(sel && answer && sel.value===answer) {
              correctCount++;
              q.el.style.background = '#e6ffed';
              detailHtml += `<div style='margin-bottom:6px;'>Q${i+1}: <span style='color:#10b981'>${answer || '-'}</span></div>`;
            } else {
              q.el.style.background = sel ? '#ffe4e6' : '';
              detailHtml += `<div style='margin-bottom:6px;'>Q${i+1}: <span style='color:#ef4444;font-weight:bold'>${userAns}</span> / <span style='color:#10b981'>${answer || '-'}</span></div>`;
            }
          }
        }
      });
      document.getElementById('score-result').innerHTML = `Correct Answers：${correctCount} / ${total}<div style='margin-top:10px;'>${detailHtml}</div>`;
    };
    // 重置答题
    document.getElementById('btnReset').onclick = function() {
      const questions = getAllQuestions();
      questions.forEach(q => {
        if(q.type === 'blank') {
          q.input.value = '';
          q.input.style.background = '';
        } else if(q.type === 'matching') {
          q.drop.textContent = '[' + q.drop.getAttribute('data-question-num') + ']';
          q.drop.style.background = '#E2F2FE';
          q.drop.removeAttribute('data-student-answer');
        } else {
          q.radios.forEach(r => r.checked=false);
        }
        q.el.style.background = '';
      });
      document.getElementById('score-result').textContent = '';
      updateCompletedList();
      updateNavQuestions();
    };

    // 拖拽支持：匹配题
    document.addEventListener('dragstart', function(e) {
      if (e.target.draggable) {
        e.dataTransfer.setData('text/plain', e.target.textContent);
        e.dataTransfer.setData('option-index', e.target.getAttribute('data-oi') || '');
      }
    });

    document.addEventListener('dragover', function(e) {
      if (e.target.classList.contains('matching-drop')) {
        e.preventDefault();
      }
      // 拖拽到屏幕空白处（不是空格/选项区），清空源空格
      if(window._dragSourceDrop && (!e.target.classList.contains('matching-drop') && !e.target.classList.contains('matching-option'))) {
        const sourceDrop = window._dragSourceDrop;
        const container = sourceDrop.closest('.matching-container');
        const isRepeatable = container.dataset.repeatable === 'true';
        const oldStudentAnswer = sourceDrop.getAttribute('data-student-answer');
        sourceDrop.textContent = '[' + sourceDrop.getAttribute('data-question-num') + ']';
        sourceDrop.style.background = '#E2F2FE';
        sourceDrop.removeAttribute('data-student-answer');
        // 不可复选时，恢复选项区对应选项显示
        if(!isRepeatable && oldStudentAnswer !== null && oldStudentAnswer !== '') {
          const allOptions = container.querySelectorAll('.matching-option[data-oi="' + oldStudentAnswer + '"]');
          allOptions.forEach(opt => opt.style.display = 'inline-block');
        }
        window._dragSourceDrop = null;
      }
    });
  // 拖拽结束后清理拖拽源
  window._dragSourceDrop = null;

    document.addEventListener('drop', function(e) {
      if (e.target.classList.contains('matching-drop')) {
          e.preventDefault();
          const type = e.dataTransfer.getData('type');
          const text = e.dataTransfer.getData('text/plain');
          const optionIndex = e.dataTransfer.getData('option-index');
          const container = e.target.closest('.matching-container');
          const isRepeatable = container.dataset.repeatable === 'true';
          // 拖拽源是选项区
          if(type === 'option') {
            if(!isRepeatable) {
              // 检查该选项是否已被其他空选中
              const usedDrops = container.querySelectorAll('.matching-drop[data-student-answer="' + optionIndex + '"]');
              if(usedDrops.length > 0) {
                // 已被选，禁止再次拖拽
                return;
              }
            }
            if (text && text.trim()) {
              // 替换时，先恢复原选项区显示
              if(!isRepeatable) {
                const oldAnswer = e.target.getAttribute('data-student-answer');
                if(oldAnswer !== null && oldAnswer !== '' && oldAnswer !== optionIndex) {
                  const oldOptions = container.querySelectorAll('.matching-option[data-oi="' + oldAnswer + '"]');
                  oldOptions.forEach(opt => opt.style.display = 'inline-block');
                }
              }
              e.target.textContent = text;
              e.target.style.background = '#e0e7ff'; // 绿色背景表示已放置
              e.target.setAttribute('data-student-answer', optionIndex);
              // 不可复选时，隐藏选项区对应选项
              if(!isRepeatable) {
                const allOptions = container.querySelectorAll('.matching-option[data-oi="' + optionIndex + '"]');
                allOptions.forEach(opt => opt.style.display = 'none');
              }
            }
          }
          // 拖拽源是另一个空格，实现交换或移动
          if(type === 'drop') {
            const sourceText = text;
            const sourceIndex = optionIndex;
            // 目标空格原有选项
            const targetOldIndex = e.target.getAttribute('data-student-answer');
            const targetOldText = e.target.textContent;
            // 源空格
            const sourceDrop = document.querySelector('.matching-drop[data-student-answer="' + sourceIndex + '"]');
            if(sourceDrop) {
              // 目标空格为空，移动
              if(!targetOldIndex || targetOldIndex === '') {
                // 源空格变空
                sourceDrop.textContent = '[' + sourceDrop.getAttribute('data-question-num') + ']';
                sourceDrop.style.background = '#E2F2FE';
                sourceDrop.removeAttribute('data-student-answer');
                // 目标空格填入选项
                e.target.textContent = sourceText;
                e.target.style.background = '#e0e7ff';
                e.target.setAttribute('data-student-answer', sourceIndex);
              } else {
                // 交换
                // 源空格填入目标内容
                sourceDrop.textContent = targetOldText;
                sourceDrop.setAttribute('data-student-answer', targetOldIndex);
                sourceDrop.style.background = '#e0e7ff';
                // 目标空格填入源内容
                e.target.textContent = sourceText;
                e.target.setAttribute('data-student-answer', sourceIndex);
                e.target.style.background = '#e0e7ff';
              }
            }
          }
          // 不可复选时，更新选项区显示
          if(!isRepeatable) {
            // 先全部显示
            const allOptions = container.querySelectorAll('.matching-option');
            allOptions.forEach(opt => opt.style.display = 'inline-block');
            // 再隐藏已被选的
            const drops = container.querySelectorAll('.matching-drop[data-student-answer]');
            drops.forEach(drop => {
              const idx = drop.getAttribute('data-student-answer');
              if(idx !== null && idx !== '') {
                const opt = container.querySelector('.matching-option[data-oi="' + idx + '"]');
                if(opt) opt.style.display = 'none';
              }
            });
          }
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('matching-drop')) {
        const container = e.target.closest('.matching-container');
        const isRepeatable = container.dataset.repeatable === 'true';
        // 用 data-student-answer 恢复选项区显示
        const oldStudentAnswer = e.target.getAttribute('data-student-answer');
        e.target.textContent = '[' + e.target.getAttribute('data-question-num') + ']';
        e.target.style.background = '#E2F2FE'; // 恢复黄色背景
        e.target.removeAttribute('data-student-answer');
        // 不可复选时，恢复选项区对应选项显示
        if(!isRepeatable && oldStudentAnswer !== null && oldStudentAnswer !== '') {
          const allOptions = container.querySelectorAll('.matching-option[data-oi="' + oldStudentAnswer + '"]');
          allOptions.forEach(opt => opt.style.display = 'inline-block');
        }
      }
    });
  // ...existing code...
  </script>
</body>
</html>
